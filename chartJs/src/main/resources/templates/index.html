<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHART</title>
    
    <!-- 부트스트랩 CSS 링크 -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<!-- 부트스트랩 JS 링크 (jQuery, Popper.js, Bootstrap JS 모두 포함) -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <!-- twbsPagination 라이브러리 링크 -->
    <!--<script src="https://cdn.jsdelivr.net/npm/twbs-pagination@1.4.2/dist/jquery.twbsPagination.min.js"></script>-->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

    <style>
        .title {
            background-color: rgb(204, 192, 218);
            width: 150px;

        }

        h4 {
            text-align: center;
            padding: 5px 5px 5px;
            margin-top: 20px;
            font-size: small;
            font-weight: 500;

        }

        .chart-chartjs {
            margin-top: 70px;

        }

        .firstChart-wrap {
            width: 45em;

        }

        .container {
            width: 45em;
            padding-top: 25px;
            margin: 0;
            margin-bottom: 30px;

        }

        .firstChart {
            padding-bottom: 17px;
            
        }

        #tabs {
            list-style-type: none;

        }

        #tabs li {
            display: inline-block;
            margin-bottom: -1px;

        }

        #tabs li a {
            display: block;
            height: 100%;
            padding: 10px;
            border-radius: 4px 4px 0 0;
            border: 1px solid;
            border-color: #ccc #ccc transparent;
            text-align: center;

        }

        #tabs li:hover a, #tabs li.active a {
            background-color: #efefef;

        }

        #tab-contents {
            border: 1px solid #ccc;
            background-color: #efefef;

        }

        #tab-contents .tab-contents {
            padding: 10px;
            display: none;

        }

        #tab-contents .tab-contents.active {
            display: block;

        }

        .pagination {
            justify-content: center;
        }

    </style>
</head>


<body>

    <div class="title">
        <h4>Vinss Academy</h4>
    </div>

    <div class="chart-chartjs">
        <div class="firstChart-wrap">
            <h6>□ 학년별 평균 시험 점수</h6>

            <div class="firstChart">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>



    <div class="container">
        <h6>□ 학년별 학생 목록</h6>

        <nav id="tabs">
          <li data-level="10" class="active"><a href="#tab1">10학년</a></li>
          <li data-level="11"><a href="#tab2">11학년</a></li>
          <li data-level="12"><a href="#tab3">12학년</a></li>
        </nav>

        <section id="tab-contents">
          <div id="tab1" class="tab-contents active">
            <div style="display: flex; justify-content: space-around;">
              <div style="width: 5%;"></div>
              <div style="width: 14%;"></div>
              <div style="width: 10%;"></div>
              <div style="width: 10%;"></div>
              <div style="width: 5%;"></div>
              <div style="width: 30%;"></div>
              <div style="width: 14%;"></div>
            </div>
            <span class="contents"></span>
            <!-- <p>These are the contents of tab 1.</p> -->

            <nav aria-label="paginationContainer">
              <ul class="pagination">
                <!-- <li class="page-item">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">◀</span>
                  </a>
                </li>
                <li class="page-item"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">▶</span>
                  </a>
                </li> -->
              </ul>
            </nav>
          </div>
        </section>

        
          
      </div>
    <script>
		
    let chartAreat = document.getElementById('myChart').getContext('2d');

    const myChart = new Chart(chartAreat, {
        type: 'line',
        
        data: {
            
            labels: ['10학년', '11학년', '12학년'],
            
            datasets: [
                {
                    label: '4',
                    data: [10, 20, 30],
                    type: 'bar'
                },

                {
                    label: '3',
                    data: [40, 50, 60],
                    type: 'bar'
                },

                {
                    label: '2',
                    data: [70, 80, 90],
                    type: 'bar'
                },

                {
                    label: '1',
                    data: [100, 110, 120],
                    type: 'bar'
                },

                {
                    label: 'MAX',
                    data: [12, 19, 3],
                    backgraoundColor: 'rgba(233, 93, 231, 2)',
                    borderColor: 'rgba(233, 93, 231, 2)',
                    borderWidth: 1
                },

                {
                    label: 'MIN',
                    data: [12, 35, 3],
                    backgraoundColor: 'rgba(255, 99, 170, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2
                  }
                ]
              },
              
              options: {
                scales: {
                y: {
                  //stacked: true,
                    beginAtZero: true
                  }
                }
              }
            });
            
            
    // 학년별 트랙별 평균 점수
    getChartData();
    async function getChartData() {
      const grade10th = await getChartDataByLevel(10);
      const grade11th = await getChartDataByLevel(11);
      const grade12th = await getChartDataByLevel(12);
      console.log("10학년" , grade10th)
      console.log("11학년" , grade11th)
      console.log("12학년" , grade12th)
      myChart.data.datasets.forEach((dataset) => {
        console.log("dataset", dataset)
        console.log(':::LABEL:::', dataset.label)
        switch(dataset.label) {
          case '4':
            dataset.data = [grade10th[3][1], grade11th[3][1], grade12th[3][1]]
            break;
          case '3':
            dataset.data = [grade10th[2][1], grade11th[2][1], grade12th[2][1]]
            break;
          case '2':
            dataset.data = [grade10th[1][1], grade11th[1][1], grade12th[1][1]]
            break;
          case '1':
            dataset.data = [grade10th[0][1], grade11th[0][1], grade12th[0][1]]
            break;
        }
        
      });
      myChart.update();
    }

    async function getChartDataByLevel(level) {
      const result = await fetch(`http://localhost:8080/chart/${level}`, {
          method: 'get'
      })
      const response = await result.json();
      console.log(response)
      return response;
    }


    // 학년별 최고/최저 점수
    getCharValue();
    async function getCharValue() {
      const maxAndMinValues = await getChartMaxAndMinValues();
      console.log("값 확인이용" , maxAndMinValues)
      myChart.data.datasets.forEach((dataset) => {
        console.log("dataset", dataset)
        console.log(':::LABEL:::', dataset.label)
        switch(dataset.label) {
          case 'MAX':
            dataset.data = [maxAndMinValues[0][1], maxAndMinValues[1][1], maxAndMinValues[2][1]]
            break;
          case 'MIN':
            dataset.data = [maxAndMinValues[0][2], maxAndMinValues[1][2], maxAndMinValues[2][2]]
            break;                  
        }
        
      });
      myChart.update();
    }

    async function getChartMaxAndMinValues() {
      const result = await fetch(`http://localhost:8080/chart/MaxAndMinValues`, {
          method: 'get'
      })
      const response = await result.json();
      console.log(response)
      return response;
    }

    // 학년별 학생 리스트 구현
    const tabLabels = document.querySelectorAll("#tabs li");
    tabLabels.forEach(function(element) {
      element.addEventListener('click', function() {
        tabLabels.forEach(element => element.classList.remove('active'));
        element.classList.add('active')
        fetchData(element.dataset.level)
      });
    })

    fetchData(10);
    async function fetchData(level) {
      const result = await fetch(`http://localhost:8080/tabList/${level}`, {method: 'get'});
      const response = await result.json();
      const responseObject = response.map((v, i) => {
        return {
          // seq: v[0],
          name: v[1],
          gender: v[2],
          level: v[3],
          track: v[4],
          title: v[5],
          value: v[6],
          page: Math.floor(i/5) + 1
        }
      })
      console.log(responseObject)
      const numberOfPages = responseObject.length%5 ? Math.floor(responseObject.length/5) + 1 : Math.floor(responseObject.length/5);
      renderPagination(numberOfPages, responseObject)
    }
    
    function renderPagination(numberOfPages, dataList) {
      const paginationString = Array(numberOfPages).fill(null).map((v, i) => `<li class="page-item"><a class="page-link" href="#">${i + 1}</a></li>`).join('')
      console.log(document.createRange().createContextualFragment(paginationString))
      document.querySelector('.pagination').innerHTML = null;
      document.querySelector('.pagination').appendChild(document.createRange().createContextualFragment(paginationString));
      renderIntialData(dataList);
      onClickButtonPagination(dataList);
    }

    function onClickButtonPagination(dataList) {
      const pageList = document.querySelectorAll('.page-item');
      pageList.forEach(function(element) {
        element.addEventListener('click', function(e) {
			e.preventDefault();
          const pageNumber = element.querySelector('.page-link').innerText;
          renderData(pageNumber, dataList);
        })
      });
    }

	function renderIntialData(dataList) {
	  const elementContents = document.querySelector('.contents');
	  const elementContentsString = `
	    <table style="width:100%; text-align:center;">
	      <thead>
	        <tr>
	          <th style="width: 5%;">No</th>
	          <th style="width: 14%;">Name</th>
	          <th style="width: 10%;">Gender</th>
	          <th style="width: 10%;">Level</th>
	          <th style="width: 5%;">Track</th>
	          <th style="width: 30%;">Title</th>
	          <th style="width: 14%;">Value</th>
	        </tr>
	        <tr><td colspan="7" style="border-bottom: 1px solid black;"></td></tr>
	      </thead>
	      <tbody>
	        ${dataList.filter((v, i) => v.page === 1).map(function(vv, ii) {
	          return `
	            <tr>
	              <td>${ii + 1}</td>
	              <td>${vv.name}</td>
	              <td>${vv.gender}</td>
	              <td>${vv.level}</td>
	              <td>${vv.track}</td>
	              <td>${vv.title}</td>
	              <td>${vv.value}</td>
	            </tr>
	          `;
	        }).join('')}
	      </tbody>
	    </table>
	  `;
	  elementContents.innerHTML = null;
	  elementContents.appendChild(document.createRange().createContextualFragment(elementContentsString));
	}
	
	function renderData(pageNumber, dataList) {
	  const elementContents = document.querySelector('.contents');
	  const elementContentsString = `
	    <table style="width:100%; text-align:center;">
	      <thead>
	        <tr>
	          <th style="width: 5%;">No</th>
	          <th style="width: 14%;">Name</th>
	          <th style="width: 10%;">Gender</th>
	          <th style="width: 10%;">Level</th>
	          <th style="width: 5%;">Track</th>
	          <th style="width: 30%;">Title</th>
	          <th style="width: 14%;">Value</th>
	        </tr>
	        <tr><td colspan="7" style="border-bottom: 1px solid black;"></td></tr>
	      </thead>
	      <tbody>
	        ${dataList.filter((v, i) => v.page === Number(pageNumber)).map(function(vv, ii) {
	          return `
	            <tr>
	              <td>${ii + 1}</td>
	              <td>${vv.name}</td>
	              <td>${vv.gender}</td>
	              <td>${vv.level}</td>
	              <td>${vv.track}</td>
	              <td>${vv.title}</td>
	              <td>${vv.value}</td>
	            </tr>
	          `;
	        }).join('')}
	      </tbody>
	    </table>
	  `;
	  elementContents.innerHTML = null;
	  elementContents.appendChild(document.createRange().createContextualFragment(elementContentsString));
	}

    </script>
</body>
</html>
